name: Release

on:
  workflow_run:
    workflows: ["Test"]
    branches:
      - main
    types:
      - completed

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Debug branch info
        run: |
          echo "Current branch: $(git branch --show-current)"
          echo "Current HEAD: $(git rev-parse HEAD)"
          echo "GITHUB_REF: $GITHUB_REF"
          echo "GITHUB_HEAD_REF: $GITHUB_HEAD_REF"
          echo "GITHUB_BASE_REF: $GITHUB_BASE_REF"
          echo "workflow_run.head_branch: ${{ github.event.workflow_run.head_branch }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install yq
        run: sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq && sudo chmod +x /usr/bin/yq

      - name: Install semantic-release dependencies
        run: npm install

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REF: refs/heads/main
          GITHUB_HEAD_REF: ""
        run: |
          # Ensure we're on main branch for semantic-release
          git checkout main
          # Set the branch explicitly for semantic-release
          export BRANCH_NAME=main
          echo "Running semantic-release on branch: $(git branch --show-current)"
          echo "GITHUB_REF is now: $GITHUB_REF"
          npx semantic-release
